<html>
  <head>
    <!-- <script src="CCapture.all.min.js"></script>
		<script src="https://unpkg.com/blob-util/dist/blob-util.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.1.1/gsap.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="gif.js"></script>
    <!-- <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/16327/DrawSVGPlugin3.min.js"></script> -->
  </head>

  <body>
    <style>
      body {
        padding: 15px;
      }

      * {
        box-sizing: border-box;
      }

      svg {
        outline: 1px solid red;
      }

      section {
        padding-top: 10px;
      }

      img {
        border: 1px solid #ddd;
        width: 100px;
        height: auto;
        margin: 0 10px 5px 0;
      }

      #gifExport {
        width: 300px;
      }
    </style>
    <!-- <canvas id="pixi_stage" width="230" height="200"></canvas>
		<script src="heartbeat.js"></script> -->

    <svg
      id="heart"
      xmlns="http://www.w3.org/2000/svg"
      width="300"
      height="300"
      viewBox="0 0 215 225"
    >
      <defs>
        <style>
          .cls-1 {
            fill: #fff;
          }
          .cls-2 {
            fill: #ff305b;
          }
          .cls-3 {
            fill: none;
            stroke: #fff;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-width: 4px;
          }
          .cls-4 {
            fill: #e62b52;
          }
          .cls-5 {
            fill: #f1f1f1;
          }
        </style>
      </defs>
      <title>heartbeat</title>
      <g id="cutlines">
        <path
          class="cls-1"
          d="M90,168.85a33.78,33.78,0,0,0,35,0c2.73-1.64,5.45-3.41,8.08-5.23,20-13.89,44.46-38.07,48.05-74.53a33.89,33.89,0,0,0,.46-5.52c0-.6,0-1.18,0-1.76a43.49,43.49,0,0,0-14.51-31,45.24,45.24,0,0,0-29.7-11.45A41.38,41.38,0,0,0,107.5,52.09,41.64,41.64,0,0,0,77.6,39.31c-20,0-38,13.94-42.89,33.14a45.93,45.93,0,0,0-1.32,9.3c0,.64,0,1.22,0,1.81a33.88,33.88,0,0,0,.45,5.52C38,131.55,70.76,157.28,90,168.85Z"
        />
      </g>
      <g id="sticker">
        <path
          class="cls-2"
          d="M107.42,164.21a24.32,24.32,0,0,1-12.56-3.49c-17.73-10.69-48-34.37-51.63-72.89a24.39,24.39,0,0,1-.38-4.27c0-.48,0-.94,0-1.4a36.78,36.78,0,0,1,1-7.37,35.05,35.05,0,0,1,33.68-26,31.75,31.75,0,0,1,29.91,21,31.62,31.62,0,0,1,29.75-21c16.44,0,33.92,12.46,34.71,33.31,0,.48,0,.95,0,1.44a24.39,24.39,0,0,1-.38,4.27c-3.12,33-25.67,55.19-44,68-2.45,1.71-5,3.36-7.57,4.91a24.41,24.41,0,0,1-12.59,3.5Z"
        />
        <path
          d="M137.26,50.31c16.1,0,32.47,12.46,33.21,31.87,0,.45,0,.91,0,1.38a22.37,22.37,0,0,1-.37,4.06c-3.08,33-26.14,54.94-43.41,66.95-2.67,1.85-5.2,3.47-7.49,4.85a22.78,22.78,0,0,1-23.6,0c-17.16-10.34-47.37-33.74-50.93-71.81a23.31,23.31,0,0,1-.36-4.06c0-.47,0-.93,0-1.38a35.15,35.15,0,0,1,1-7C49.26,59.82,63.52,50.31,77.6,50.31a30.19,30.19,0,0,1,29.91,25.84,30.07,30.07,0,0,1,29.75-25.84m0-3a33.15,33.15,0,0,0-29.75,18.58A33.33,33.33,0,0,0,77.6,47.31,36.55,36.55,0,0,0,42.47,74.42a37.73,37.73,0,0,0-1.09,7.64c0,.51,0,1,0,1.5A25.7,25.7,0,0,0,41.74,88c3.72,39.14,34.39,63.14,52.35,74a25.78,25.78,0,0,0,26.7,0c2.59-1.56,5.16-3.23,7.65-5,18.63-13,41.49-35.44,44.68-69a26.71,26.71,0,0,0,.39-4.47c0-.51,0-1,0-1.49a35.46,35.46,0,0,0-11.84-25.34,37.13,37.13,0,0,0-24.37-9.42Z"
        />
        <path class="cls-3" d="M148.36,121.71c-.45.64-.9,1.26-1.36,1.88" />
        <path class="cls-3" d="M155.67,109a77.35,77.35,0,0,1-4.4,8.32" />
        <path
          class="cls-3"
          d="M161.84,82.5c0,.33-.3,4.32-.3,4.32a68.79,68.79,0,0,1-3.7,16.72"
        />
        <path
          class="cls-4"
          d="M44.35,83.56a23.31,23.31,0,0,0,.36,4.06c3.56,38.07,33.77,61.47,50.93,71.82a22.76,22.76,0,0,0,22.61.56l.26-.14C57.87,136.05,49.12,98.59,45.37,75.15a35.15,35.15,0,0,0-1,7C44.37,82.63,44.35,83.09,44.35,83.56Z"
        />
        <ellipse
          class="cls-5"
          cx="147.55"
          cy="67.82"
          rx="6.68"
          ry="14.35"
          transform="translate(8.68 152) rotate(-55.91)"
        />
      </g>
    </svg>

    <section></section>
    <script>
      var speed = 0.1; //seconds
      var heart = document.getElementById("heart");

      var anime = TweenMax.to(heart, 1, {
        scaleX: 1.2,
        scaleY: 1.3,
        ease: Elastic.easeOut,
        repeat: -1,
        repeatDelay: speed
      });

      //   var anime = TweenMax.to(heart, 1, { rotation: 360 });

      var svg = document.querySelector("svg");
      var list = document.querySelector("section");

      //   TweenLite.set(".path", { drawSVG: 0 });

      //   var animation = TweenMax.to(".path", 0.5, {
      //     drawSVG: true,
      //     paused: true,
      //     repeat: -1,
      //     yoyo: true
      //   });

      console.log(anime.duration());

      var fps = 60;
      var duration = anime.duration();
      var frames = Math.ceil((duration / 1) * fps);
      var current = 0;

      var renderedFrames = [];

      processImage();

      async function processImage() {
        anime.progress(current++ / frames);

        var xml = new XMLSerializer().serializeToString(svg);
        var blob = new Blob([xml], { type: "image/svg+xml" });
        var img = new Image();

        img.width = 300;
        img.height = 200;
        img.crossOrigin = "Anonymous";
        img.className = "frames";
        img.onload = function() {
          list.appendChild(this);
        };

        img.src = URL.createObjectURL(blob);
        renderedFrames.push(img.src);

        // renderedFrames.push({src: img.src, text: "110 bpm"});

        if (current <= frames) {
          processImage();
        } else {
          anime.play(0);
          console.log("all frames captured");
          await renderGif();
        }
      }


      function renderGif() {
        var gif = new GIF({
          workers: 2,
          quality: 10,
          width: 300,
          height: 300
        });

        console.log(document.getElementsByClassName("frames")[1]);
        for (var i = 0; i < document.getElementsByClassName("frames").length; i++) {
          console.log(i);
          gif.addFrame(document.getElementsByClassName("frames")[i]);
        }

        gif.on("finished", function(blob) {

          var image = blob,
			animatedImage = document.createElement('img');
			animatedImage.src = image;
			animatedImage.id = "gifExport";
      document.body.appendChild(animatedImage);
      
          // window.open(URL.createObjectURL(blob));
        });

        gif.render();
      }
    </script>
  </body>
</html>
